<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-2xl mx-auto px-4">
    <!-- 헤더 -->
    <div class="mb-8">
      <div class="flex items-center space-x-4 mb-4">
        <%= link_to admin_bakeries_path, class: "flex items-center justify-center w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors" do %>
          <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        <% end %>
        <div>
          <h1 class="text-2xl font-bold text-gray-900">베이커리 정보 수정</h1>
          <p class="text-gray-600"><%= @bakery.name %> 정보를 수정합니다</p>
        </div>
      </div>
    </div>

    <!-- 폼 -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
      <%= form_with model: [:admin, @bakery], local: true, multipart: true, class: "space-y-6" do |form| %>
        
        <% if @bakery.errors.any? %>
          <div class="p-6 bg-red-50 border-b border-red-100">
            <h3 class="text-red-800 font-semibold mb-2"><%= pluralize(@bakery.errors.count, "error") %> 발생:</h3>
            <ul class="list-disc list-inside text-red-700 text-sm">
              <% @bakery.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>
        
        <!-- 가게 정보 입력 섹션 -->
        <div class="p-6 border-b border-gray-100">
          <div class="flex items-center space-x-3 mb-6">
            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h3M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
              </svg>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">가게 정보 입력</h2>
          </div>

          <div class="space-y-5">
            <!-- 가게 이름 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                가게 이름 <span class="text-red-500">*</span>
              </label>
              <%= form.text_field :name, 
                  placeholder: "예: 달콤한 베이커리",
                  required: true,
                  class: "w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors text-gray-900 placeholder-gray-500 outline-none" %>
            </div>

            <!-- 카테고리 -->
            <div class="relative">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                카테고리 <span class="text-red-500">*</span>
              </label>
              <%= form.select :category,
                  options_for_select([
                    ['베이커리', '베이커리'],
                    ['카페', '카페'],
                    ['디저트전문점', '디저트전문점'],
                    ['케이크샵', '케이크샵']
                  ]),
                  { prompt: '카테고리를 선택해주세요' },
                  {
                    required: true,
                    class: "w-full px-4 py-3 pr-10 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors text-gray-900 bg-white appearance-none outline-none"
                  } %>
              <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none" style="top: 28px;">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
            </div>

            <!-- 매장 유형 -->
            <div class="relative">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                매장 유형 <span class="text-red-500">*</span>
              </label>
              <%= form.select :store_type,
                  options_for_select(Bakery::STORE_TYPES.map { |k, v| [v, k] }, @bakery.store_type),
                  {},
                  {
                    required: true,
                    id: "store_type_select",
                    class: "w-full px-4 py-3 pr-10 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors text-gray-900 bg-white appearance-none outline-none"
                  } %>
              <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none" style="top: 28px;">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
            </div>

            <!-- 본점 선택 (지점/팝업인 경우) -->
            <div id="parent_bakery_field" class="<%= 'hidden' if @bakery.main? %>">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                본점 선택
              </label>
              <%= form.hidden_field :parent_id, id: "parent_id_hidden" %>
              <div class="flex space-x-2">
                <div id="selected_parent_display" class="flex-1 px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 text-gray-900">
                  <% if @bakery.parent.present? %>
                    <span class="text-gray-900"><%= @bakery.parent.name %></span>
                  <% else %>
                    <span class="text-gray-500">본점을 선택해주세요</span>
                  <% end %>
                </div>
                <button type="button"
                        onclick="openParentBakeryModal()"
                        class="px-6 py-3 bg-orange-500 text-white rounded-xl font-medium hover:bg-orange-600 transition-colors whitespace-nowrap">
                  본점 검색
                </button>
                <% if @bakery.parent.present? %>
                  <button type="button"
                          onclick="clearParentBakery()"
                          class="px-4 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                <% end %>
              </div>
              <p class="mt-1 text-xs text-gray-500">지점이나 팝업의 경우 본점을 선택해주세요</p>
            </div>
          </div>
        </div>

        <!-- 위치 정보 섹션 -->
        <div class="p-6 border-b border-gray-100">
          <div class="flex items-center space-x-3 mb-6">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">주소</h2>
          </div>

          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                주소 <span class="text-red-500">*</span>
              </label>
              <div class="flex space-x-2">
                <input type="text" 
                       id="postcode" 
                       value="<%= @bakery.postcode %>"
                       placeholder="우편번호" 
                       readonly
                       class="w-32 px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 text-gray-900 outline-none">
                <button type="button" 
                        onclick="openDaumPostcode()"
                        class="px-6 py-3 bg-orange-500 text-white rounded-xl font-medium hover:bg-orange-600 transition-colors">
                  주소 검색
                </button>
              </div>
            </div>
            
            <div>
              <input type="text"
                     id="roadAddress"
                     value="<%= @bakery.road_address %>"
                     placeholder="도로명 주소"
                     required
                     readonly
                     class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 text-gray-900 outline-none">
            </div>
            
            <div>
              <input type="text" 
                     id="jibunAddress"
                     value="<%= @bakery.jibun_address %>"
                     placeholder="지번 주소" 
                     readonly
                     class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 text-gray-900 outline-none">
            </div>
            
            <div>
              <input type="text" 
                     id="detailAddress"
                     value="<%= @bakery.detail_address %>"
                     placeholder="상세 주소를 입력해주세요"
                     class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors text-gray-900 placeholder-gray-500 outline-none">
            </div>
            
            <div>
              <input type="text" 
                     id="extraAddress"
                     value="<%= @bakery.extra_address %>" 
                     placeholder="참고 항목" 
                     readonly
                     class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50 text-gray-900 outline-none">
            </div>
          </div>
        </div>

        <!-- 연락처 정보 섹션 -->
        <div class="p-6 border-b border-gray-100">
          <div class="flex items-center space-x-3 mb-6">
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
              </svg>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">전화번호</h2>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              전화번호 <span class="text-red-500">*</span>
            </label>
            <%= form.telephone_field :phone, 
                placeholder: "02-123-4567",
                required: true,
                class: "w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors text-gray-900 placeholder-gray-500 outline-none" %>
          </div>
        </div>

        <!-- 운영시간 섹션 -->
        <div class="p-6 border-b border-gray-100">
          <div class="flex items-center space-x-3 mb-6">
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">운영시간</h2>
          </div>

          <div class="space-y-4">
            <% %w[monday tuesday wednesday thursday friday saturday sunday].each_with_index do |day, index| %>
              <% day_name = %w[월 화 수 목 금 토 일][index] %>
              <% day_hours = @bakery.operating_hours_data[day] %>
              <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
                <div class="w-8 text-center">
                  <span class="font-medium text-gray-700"><%= day_name %></span>
                </div>
                
                <div class="flex items-center space-x-2">
                  <input type="checkbox" 
                         id="<%= day %>_closed" 
                         name="operating_hours[<%= day %>][closed]" 
                         value="1"
                         <%= 'checked' if day_hours["closed"] %>
                         onchange="toggleDayInputs('<%= day %>')"
                         class="rounded text-orange-500 focus:ring-orange-500">
                  <label for="<%= day %>_closed" class="text-sm text-gray-600">휴무</label>
                </div>
                
                <div id="<%= day %>_inputs" class="flex items-center space-x-2 flex-1" <%= 'style="opacity: 0.5;"' if day_hours["closed"] %>>
                  <%= select_tag "operating_hours[#{day}][open_time]", 
                      options_for_select(time_options, day_hours["open_time"]),
                      disabled: day_hours["closed"],
                      class: "px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" %>
                  <span class="text-gray-500">-</span>
                  <%= select_tag "operating_hours[#{day}][close_time]", 
                      options_for_select(time_options, day_hours["close_time"]),
                      disabled: day_hours["closed"],
                      class: "px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" %>
                  <div class="flex items-center space-x-2 ml-4">
                    <%= select_tag "operating_hours[#{day}][last_order]", 
                        options_for_select(time_options, day_hours["last_order"]),
                        disabled: day_hours["closed"],
                        class: "px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500" %>
                    <span class="text-sm text-gray-500">라스트오더</span>
                  </div>
                </div>
              </div>
            <% end %>
            
            <div class="flex justify-end">
              <button type="button" onclick="copyToAll()" class="text-sm text-orange-600 hover:text-orange-700 font-medium">
                월요일 시간을 모든 요일에 적용
              </button>
            </div>
          </div>
        </div>

        <!-- 가게 이미지 섹션 -->
        <div class="p-6 border-b border-gray-100">
          <div class="flex items-center space-x-3 mb-6">
            <div class="w-10 h-10 bg-pink-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">가게 이미지</h2>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">이미지 업로드</label>
            <p class="text-sm text-gray-500 mb-3">이미지를 업로드하거나 드래그해주세요. JPG, PNG, WebP 형식을 지원합니다.</p>
            
            <!-- 드래그 앤 드롭 영역 -->
            <div id="dropZone" class="relative border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-gray-400 transition-colors cursor-pointer">
              <div id="dropZoneContent">
                <div class="space-y-4">
                  <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                  </div>
                  <div>
                    <p class="text-gray-600 font-medium">이미지 추가</p>
                    <p class="text-sm text-gray-500">클릭하거나 이미지를 드래그해주세요</p>
                  </div>
                </div>
              </div>
              <input type="file" name="bakery[cloudflare_images][]"
                  id="imageInput"
                  multiple
                  accept="image/*"
                  class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
            </div>
            
            <!-- 이미지 미리보기 -->
            <div id="imagePreview" class="mt-4 hidden">
              <p class="text-sm font-medium text-gray-700 mb-2">가게 이미지 (최대 5장)</p>
              <div id="previewContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <!-- 미리보기 이미지들이 여기에 표시됩니다 -->
              </div>
            </div>
            
            <% if @bakery.persisted? && @bakery.images? %>
              <div class="mt-4">
                <p class="text-sm text-gray-600 mb-2">현재 이미지:</p>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                  <% @bakery.images_urls.each do |url| %>
                    <div class="relative group">
                      <img src="<%= url %>" class="w-full h-24 object-cover rounded-lg" alt="">
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- 가게 설명 섹션 -->
        <div class="p-6">
          <div class="flex items-center space-x-3 mb-6">
            <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
            </div>
            <h2 class="text-lg font-semibold text-gray-900">가게 설명</h2>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              가게 설명 <span class="text-red-500">*</span>
            </label>
            <%= form.text_area :description, 
                placeholder: "가게의 특징, 대표 메뉴, 분위기 등을 소개해주세요...",
                required: true,
                rows: 5,
                class: "w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors text-gray-900 placeholder-gray-500 resize-none outline-none" %>
          </div>
        </div>

        <!-- 숨겨진 주소 필드들 -->
        <%= form.hidden_field :postcode, id: "postcode_hidden" %>
        <%= form.hidden_field :road_address, id: "road_address_hidden" %>
        <%= form.hidden_field :jibun_address, id: "jibun_address_hidden" %>
        <%= form.hidden_field :detail_address, id: "detail_address_hidden" %>
        <%= form.hidden_field :extra_address, id: "extra_address_hidden" %>

        <!-- 버튼 섹션 -->
        <div class="p-6 bg-gray-50 border-t border-gray-100">
          <div class="flex space-x-4">
            <%= link_to "취소", admin_bakeries_path, class: "flex-1 py-3 px-4 bg-white border border-gray-300 rounded-xl text-center font-medium text-gray-700 hover:bg-gray-50 transition-colors" %>
            <%= form.submit "정보 수정하기", class: "flex-1 py-3 px-4 bg-gray-900 text-white rounded-xl font-medium hover:bg-gray-800 transition-colors cursor-pointer" %>
          </div>
        </div>

      <% end %>
    </div>
  </div>
</div>

<!-- Daum 우편번호 서비스 -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
  function openDaumPostcode() {
    new daum.Postcode({
      oncomplete: function(data) {
        // 우편번호와 주소 정보를 해당 필드에 넣는다.
        document.getElementById('postcode').value = data.zonecode;
        document.getElementById('roadAddress').value = data.roadAddress;
        document.getElementById('jibunAddress').value = data.jibunAddress;
        
        // 참고항목 문자열이 있을 때 해당 필드에 넣는다.
        var extraAddr = '';
        
        // 법정동명이 있을 경우 추가한다. (법정리는 제외)
        // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
        if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
          extraAddr += data.bname;
        }
        // 건물명이 있고, 공동주택일 경우 추가한다.
        if(data.buildingName !== '' && data.apartment === 'Y'){
          extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
        }
        // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
        if(extraAddr !== ''){
          extraAddr = ' (' + extraAddr + ')';
        }
        // 참고항목 문자열이 있을 경우 해당 필드에 넣는다.
        document.getElementById("extraAddress").value = extraAddr;
        
        // 커서를 상세주소 필드로 이동한다.
        document.getElementById("detailAddress").focus();
        
        // 숨겨진 필드들도 업데이트
        updateHiddenFields();
      }
    }).open();
  }
  
  function updateHiddenFields() {
    // 각 표시 필드의 값을 숨겨진 필드로 복사
    document.getElementById('postcode_hidden').value = document.getElementById('postcode').value;
    document.getElementById('road_address_hidden').value = document.getElementById('roadAddress').value;
    document.getElementById('jibun_address_hidden').value = document.getElementById('jibunAddress').value;
    document.getElementById('detail_address_hidden').value = document.getElementById('detailAddress').value;
    document.getElementById('extra_address_hidden').value = document.getElementById('extraAddress').value;
  }
  
  // 페이지 로드 시 초기 값 설정
  document.addEventListener('DOMContentLoaded', function() {
    // 상세주소 입력 시 숨겨진 필드 업데이트
    var detailAddressField = document.getElementById('detailAddress');
    if (detailAddressField) {
      detailAddressField.addEventListener('input', function() {
        document.getElementById('detail_address_hidden').value = this.value;
      });
    }
  });
  
  // 폼 제출 전 모든 숨겨진 필드 업데이트
  document.addEventListener('DOMContentLoaded', function() {
    var form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function() {
        updateHiddenFields();
      });
    }
  });
  
  // 주소 입력 초기화 함수
  function initializeAddressInput() {
    var detailAddressField = document.getElementById('detailAddress');
    if (detailAddressField) {
      detailAddressField.addEventListener('input', updateFullAddress);
    }
    
    // 폼 제출 시 주소 업데이트 확인
    var form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(e) {
        var roadAddr = document.getElementById('roadAddress').value.trim();
        if (!roadAddr) {
          e.preventDefault();
          alert('주소 검색을 먼저 해주세요.');
          return false;
        }
        updateFullAddress();
      });
    }
  }

  // DOMContentLoaded와 Turbo 이벤트 모두에 대응
  document.addEventListener('DOMContentLoaded', initializeAddressInput);
  document.addEventListener('turbo:load', initializeAddressInput);
  document.addEventListener('turbo:render', initializeAddressInput);
  
  function updateFullAddress() {
    var roadAddr = document.getElementById('roadAddress').value;
    var detailAddr = document.getElementById('detailAddress').value;
    var extraAddr = document.getElementById('extraAddress').value;
    
    // 도로명 주소가 없으면 업데이트하지 않음
    if (!roadAddr.trim()) {
      return;
    }
    
    var fullAddress = roadAddr;
    if (detailAddr) {
      fullAddress += ' ' + detailAddr;
    }
    if (extraAddr) {
      fullAddress += extraAddr;
    }
    
    // hidden field를 만들어서 전체 주소를 저장
    var hiddenField = document.getElementById('full_address_hidden');
    if (!hiddenField) {
      hiddenField = document.createElement('input');
      hiddenField.type = 'hidden';
      hiddenField.id = 'full_address_hidden';
      hiddenField.name = 'bakery[address]';
      document.querySelector('form').appendChild(hiddenField);
    }
    hiddenField.value = fullAddress;
    
    // 기존 address 필드는 display용으로만 사용 (name 속성 제거)
    var roadAddressField = document.getElementById('roadAddress');
    if (roadAddressField && roadAddressField.hasAttribute('name')) {
      roadAddressField.removeAttribute('name');
    }
  }
</script>

<script>
// 싱글톤 패턴으로 이미지 업로드 관리
(function() {
  // 전역 네임스페이스에 단 하나의 인스턴스만 생성
  if (window.AdminImageUploadManager) {
    return; // 이미 존재하면 재생성하지 않음
  }

  window.AdminImageUploadManager = {
    initialized: false,
    selectedFiles: [],
    maxFiles: 5,
    handlers: {},
    
    init: function() {
      // 이미 초기화되었으면 리턴
      if (this.initialized) {
        console.log('AdminImageUploadManager already initialized, skipping...');
        return;
      }
      
      const dropZone = document.getElementById('dropZone');
      const imageInput = document.getElementById('imageInput');
      const imagePreview = document.getElementById('imagePreview');
      const previewContainer = document.getElementById('previewContainer');
      const dropZoneContent = document.getElementById('dropZoneContent');
      
      if (!dropZone || !imageInput) return;
      
      // 기존 이벤트 리스너 제거
      this.cleanup();
      
      // selectedFiles 초기화
      this.selectedFiles = [];
      
      const self = this;
      
      // 이벤트 핸들러 정의
      this.handlers.dragOver = function(e) {
        e.preventDefault();
        dropZone.classList.add('border-orange-400', 'bg-orange-50');
      };
      
      this.handlers.dragLeave = function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-orange-400', 'bg-orange-50');
      };
      
      this.handlers.drop = function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-orange-400', 'bg-orange-50');
        
        const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
        self.handleFiles(files, dropZone, imageInput, imagePreview, previewContainer, dropZoneContent);
      };
      
      this.handlers.change = function(e) {
        const files = Array.from(e.target.files);
        self.handleFiles(files, dropZone, imageInput, imagePreview, previewContainer, dropZoneContent);
      };
      
      // 이벤트 리스너 추가
      dropZone.addEventListener('dragover', this.handlers.dragOver);
      dropZone.addEventListener('dragleave', this.handlers.dragLeave);
      dropZone.addEventListener('drop', this.handlers.drop);
      imageInput.addEventListener('change', this.handlers.change);
      
      this.initialized = true;
      console.log('AdminImageUploadManager initialized');
    },
    
    cleanup: function() {
      const dropZone = document.getElementById('dropZone');
      const imageInput = document.getElementById('imageInput');
      
      if (dropZone && this.handlers.dragOver) {
        dropZone.removeEventListener('dragover', this.handlers.dragOver);
        dropZone.removeEventListener('dragleave', this.handlers.dragLeave);
        dropZone.removeEventListener('drop', this.handlers.drop);
      }
      
      if (imageInput && this.handlers.change) {
        imageInput.removeEventListener('change', this.handlers.change);
      }
      
      this.handlers = {};
      this.selectedFiles = [];
      this.initialized = false;
    },
    
    handleFiles: function(files, dropZone, imageInput, imagePreview, previewContainer, dropZoneContent) {
      // 최대 파일 개수 체크
      if (this.selectedFiles.length + files.length > this.maxFiles) {
        alert(`최대 ${this.maxFiles}장까지 업로드할 수 있습니다.`);
        files = files.slice(0, this.maxFiles - this.selectedFiles.length);
      }
      
      const self = this;
      files.forEach(file => {
        if (file.type.startsWith('image/')) {
          self.selectedFiles.push(file);
          self.addPreviewImage(file, previewContainer);
        }
      });
      
      this.updateFileInput(imageInput);
      this.updateDropZoneState(imagePreview, dropZoneContent);
    }
,
    
    addPreviewImage: function(file, previewContainer) {
      const reader = new FileReader();
      const self = this;
      
      reader.onload = function(e) {
        const previewItem = document.createElement('div');
        previewItem.className = 'relative group';
        const index = self.selectedFiles.indexOf(file);
        previewItem.innerHTML = `
          <div class="relative">
            <img src="${e.target.result}" alt="미리보기" class="w-full h-24 object-cover rounded-lg border border-gray-200">
            <button type="button" onclick="AdminImageUploadManager.removeImage(${index})" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 transition-colors opacity-0 group-hover:opacity-100">
              <svg class="w-3 h-3 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        `;
        previewContainer.appendChild(previewItem);
      };
      
      reader.readAsDataURL(file);
    }
,
    
    updateFileInput: function(imageInput) {
      const dt = new DataTransfer();
      this.selectedFiles.forEach(file => dt.items.add(file));
      imageInput.files = dt.files;
    },
    
    updateDropZoneState: function(imagePreview, dropZoneContent) {
      if (this.selectedFiles.length > 0) {
        imagePreview.classList.remove('hidden');
        dropZoneContent.innerHTML = `
          <div class="space-y-2">
            <div class="mx-auto w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
            </div>
            <p class="text-gray-600 font-medium text-sm">이미지 더 추가</p>
            <p class="text-xs text-gray-500">${this.selectedFiles.length}/${this.maxFiles}</p>
          </div>
        `;
      } else {
        imagePreview.classList.add('hidden');
        dropZoneContent.innerHTML = `
          <div class="space-y-4">
            <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
              <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
            </div>
            <div>
              <p class="text-gray-600 font-medium">이미지 추가</p>
              <p class="text-sm text-gray-500">클릭하거나 이미지를 드래그해주세요</p>
            </div>
          </div>
        `;
      }
    },
    
    removeImage: function(index) {
      const previewContainer = document.getElementById('previewContainer');
      const imagePreview = document.getElementById('imagePreview');
      const dropZoneContent = document.getElementById('dropZoneContent');
      const imageInput = document.getElementById('imageInput');
      const previewItems = previewContainer.querySelectorAll('.group');
      
      if (index >= 0 && index < this.selectedFiles.length) {
        this.selectedFiles.splice(index, 1);
        previewItems[index].remove();
        
        // 인덱스 재조정
        const remainingItems = previewContainer.querySelectorAll('.group');
        remainingItems.forEach((item, i) => {
          const button = item.querySelector('button');
          if (button) {
            button.setAttribute('onclick', `AdminImageUploadManager.removeImage(${i})`);
          }
        });
        
        this.updateFileInput(imageInput);
        this.updateDropZoneState(imagePreview, dropZoneContent);
      }
    }
  };
})();

// 이벤트 리스너 등록
document.addEventListener('DOMContentLoaded', function() {
  if (window.AdminImageUploadManager) {
    window.AdminImageUploadManager.init();
  }
});

document.addEventListener('turbo:load', function() {
  if (window.AdminImageUploadManager) {
    window.AdminImageUploadManager.cleanup();
    window.AdminImageUploadManager.init();
  }
});

document.addEventListener('turbo:before-cache', function() {
  if (window.AdminImageUploadManager) {
    window.AdminImageUploadManager.cleanup();
  }
});

// 전역 함수로 노출 (기존 코드와의 호환성을 위해)
window.removeImage = function(button) {
  // 비어있는 함수 - AdminImageUploadManager.removeImage를 사용
};

// 운영시간 관련 JavaScript
function toggleDayInputs(day) {
  const checkbox = document.getElementById(day + '_closed');
  const inputs = document.getElementById(day + '_inputs');
  
  if (checkbox.checked) {
    inputs.style.opacity = '0.5';
    inputs.querySelectorAll('select').forEach(select => select.disabled = true);
  } else {
    inputs.style.opacity = '1';
    inputs.querySelectorAll('select').forEach(select => select.disabled = false);
  }
}

function copyToAll() {
  const mondayInputs = {
    closed: document.querySelector('input[name="operating_hours[monday][closed]"]').checked,
    open_time: document.querySelector('select[name="operating_hours[monday][open_time]"]').value,
    close_time: document.querySelector('select[name="operating_hours[monday][close_time]"]').value,
    last_order: document.querySelector('select[name="operating_hours[monday][last_order]"]').value
  };

  const days = ['tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

  days.forEach(day => {
    document.querySelector(`input[name="operating_hours[${day}][closed]"]`).checked = mondayInputs.closed;
    document.querySelector(`select[name="operating_hours[${day}][open_time]"]`).value = mondayInputs.open_time;
    document.querySelector(`select[name="operating_hours[${day}][close_time]"]`).value = mondayInputs.close_time;
    document.querySelector(`select[name="operating_hours[${day}][last_order]"]`).value = mondayInputs.last_order;

    toggleDayInputs(day);
  });
}

// 매장 유형 변경 시 본점 선택 필드 표시/숨김
function initStoreTypeToggle() {
  const storeTypeSelect = document.getElementById('store_type_select');
  const parentBakeryField = document.getElementById('parent_bakery_field');
  const parentIdSelect = document.getElementById('parent_id_select');

  if (!storeTypeSelect || !parentBakeryField) return;

  storeTypeSelect.addEventListener('change', function() {
    if (this.value === 'main') {
      parentBakeryField.classList.add('hidden');
      if (parentIdSelect) parentIdSelect.value = '';
    } else {
      parentBakeryField.classList.remove('hidden');
    }
  });
}

document.addEventListener('DOMContentLoaded', initStoreTypeToggle);
document.addEventListener('turbo:load', initStoreTypeToggle);

// 본점 검색 모달 관련 JavaScript
const ParentBakeryModal = {
  debounceTimer: null,
  excludeId: '<%= @bakery.id %>',

  open: function() {
    document.getElementById('parentBakeryModal').classList.remove('hidden');
    document.getElementById('parentSearchInput').value = '';
    document.getElementById('parentSearchResults').innerHTML = '';
    setTimeout(() => document.getElementById('parentSearchInput').focus(), 100);
    this.search('');
  },

  close: function() {
    document.getElementById('parentBakeryModal').classList.add('hidden');
  },

  search: function(query) {
    clearTimeout(this.debounceTimer);
    this.debounceTimer = setTimeout(() => {
      const resultsContainer = document.getElementById('parentSearchResults');
      resultsContainer.innerHTML = '<div class="p-4 text-center text-gray-500">검색 중...</div>';

      fetch(`/bakeries/search?q=${encodeURIComponent(query)}&exclude_id=${this.excludeId}`)
        .then(response => response.json())
        .then(bakeries => {
          if (bakeries.length === 0) {
            resultsContainer.innerHTML = '<div class="p-4 text-center text-gray-500">검색 결과가 없습니다</div>';
            return;
          }

          resultsContainer.innerHTML = bakeries.map(bakery => `
            <button type="button"
                    onclick="ParentBakeryModal.select(${bakery.id}, '${bakery.name.replace(/'/g, "\\'")}')"
                    class="w-full p-4 text-left hover:bg-orange-50 border-b border-gray-100 last:border-b-0 transition-colors">
              <div class="font-medium text-gray-900">${bakery.name}</div>
              <div class="text-sm text-gray-500">${bakery.address || '주소 정보 없음'}</div>
            </button>
          `).join('');
        })
        .catch(error => {
          resultsContainer.innerHTML = '<div class="p-4 text-center text-red-500">검색 중 오류가 발생했습니다</div>';
        });
    }, 300);
  },

  select: function(id, name) {
    document.getElementById('parent_id_hidden').value = id;
    document.getElementById('selected_parent_display').innerHTML = `<span class="text-gray-900">${name}</span>`;

    // 선택 해제 버튼 추가
    const displayContainer = document.getElementById('selected_parent_display').parentElement;
    let clearBtn = displayContainer.querySelector('.clear-parent-btn');
    if (!clearBtn) {
      clearBtn = document.createElement('button');
      clearBtn.type = 'button';
      clearBtn.className = 'clear-parent-btn px-4 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300 transition-colors';
      clearBtn.onclick = clearParentBakery;
      clearBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
      displayContainer.appendChild(clearBtn);
    }

    this.close();
  }
};

function openParentBakeryModal() {
  ParentBakeryModal.open();
}

function clearParentBakery() {
  document.getElementById('parent_id_hidden').value = '';
  document.getElementById('selected_parent_display').innerHTML = '<span class="text-gray-500">본점을 선택해주세요</span>';

  // 선택 해제 버튼 제거
  const clearBtn = document.querySelector('.clear-parent-btn');
  if (clearBtn) clearBtn.remove();
}
</script>

<!-- 본점 검색 모달 -->
<div id="parentBakeryModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
    <!-- 배경 오버레이 -->
    <div class="fixed inset-0 bg-gray-500 opacity-75 transition-opacity" onclick="ParentBakeryModal.close()"></div>

    <!-- 모달 컨텐츠 -->
    <div class="relative bg-white rounded-2xl shadow-xl transform transition-all sm:max-w-lg sm:w-full mx-4 overflow-hidden">
      <!-- 모달 헤더 -->
      <div class="flex items-center justify-between p-6 border-b border-gray-100">
        <h3 class="text-lg font-semibold text-gray-900">본점 검색</h3>
        <button type="button" onclick="ParentBakeryModal.close()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- 검색 입력 -->
      <div class="p-6 border-b border-gray-100">
        <div class="relative">
          <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input type="text"
                 id="parentSearchInput"
                 placeholder="베이커리 이름으로 검색..."
                 oninput="ParentBakeryModal.search(this.value)"
                 class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors text-gray-900 placeholder-gray-500 outline-none">
        </div>
      </div>

      <!-- 검색 결과 -->
      <div id="parentSearchResults" class="max-h-80 overflow-y-auto">
        <!-- 검색 결과가 여기에 표시됩니다 -->
      </div>
    </div>
  </div>
</div>

<div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-2xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <div class="bg-gradient-to-r from-amber-500 to-orange-600 px-8 py-6">
        <h1 class="text-2xl font-bold text-white">프로필 수정</h1>
        <p class="text-amber-50 mt-1">계정 정보를 수정할 수 있습니다</p>
      </div>

      <div class="p-8">
        <%= form_with model: @user, url: user_path, local: true, html: { multipart: true } do |form| %>
          <% if @user.errors.any? %>
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
              <ul class="list-disc list-inside text-sm">
                <% @user.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <div class="space-y-6">
            <!-- 프로필 이미지 섹션 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">프로필 이미지</label>
              <div class="flex items-center space-x-6">
                <div class="relative">
                  <% if @user.profile_image? %>
                    <img src="<%= @user.profile_image_url %>" class="w-24 h-24 rounded-full object-cover border-4 border-gray-200" id="profile-image-preview" alt="">
                  <% else %>
                    <div id="default-avatar" class="w-24 h-24 rounded-full bg-gradient-to-br from-amber-400 to-orange-600 flex items-center justify-center text-white text-3xl font-bold">
                      <%= @user.email_address[0].upcase %>
                    </div>
                    <img src="" class="w-24 h-24 rounded-full object-cover border-4 border-gray-200 hidden" id="profile-image-preview" alt="">
                  <% end %>
                </div>
                <div class="flex-1">
                  <label for="profile-image-input" class="cursor-pointer inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">
                    새 이미지 선택
                  </label>
                  <input type="file" name="user[cloudflare_profile_image]" class="hidden" accept="image/png,image/jpeg,image/jpg,image/gif" id="profile-image-input">
                  <p class="mt-2 text-xs text-gray-500">JPG, PNG, GIF 파일 (최대 5MB)</p>
                  <p id="file-error" class="mt-1 text-xs text-red-600 hidden">파일 크기는 5MB 이하여야 합니다.</p>
                </div>
              </div>
            </div>

            <div>
              <%= form.label :nickname, "닉네임", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_field :nickname,
                  class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition duration-200",
                  placeholder: "닉네임을 입력하세요" %>
              <p class="mt-1 text-xs text-gray-500">다른 사용자에게 표시되는 이름입니다</p>
            </div>

            <div>
              <%= form.label :email_address, "이메일 주소", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.email_field :email_address,
                  class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition duration-200 bg-gray-100",
                  placeholder: "your@email.com", disabled: true %>
            </div>

            <div class="border-t border-gray-200 pt-6">
              <h3 class="text-lg font-medium text-gray-900 mb-4">비밀번호 변경</h3>
              <p class="text-sm text-gray-600 mb-4">비밀번호를 변경하지 않으려면 아래 필드를 비워두세요.</p>

              <div class="space-y-4">
                <div>
                  <%= form.label :password, "새 비밀번호", class: "block text-sm font-medium text-gray-700 mb-2" %>
                  <%= form.password_field :password,
                      class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition duration-200",
                      placeholder: "최소 8자 이상",
                      autocomplete: "new-password" %>
                </div>

                <div>
                  <%= form.label :password_confirmation, "비밀번호 확인", class: "block text-sm font-medium text-gray-700 mb-2" %>
                  <%= form.password_field :password_confirmation,
                      class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent transition duration-200",
                      placeholder: "비밀번호를 다시 입력하세요",
                      autocomplete: "new-password" %>
                </div>
              </div>
            </div>

            <div class="flex items-center justify-between pt-6">
              <%= link_to "취소", root_path,
                  class: "px-6 py-3 text-gray-700 bg-gray-200 rounded-lg font-medium hover:bg-gray-300 transition duration-200" %>
              <%= form.submit "저장하기",
                  class: "px-6 py-3 text-white rounded-lg font-medium bg-orange-500 hover:bg-orange-600 transition duration-200 cursor-pointer" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div class="mt-8 text-center">
      <div class="bg-white rounded-lg shadow px-6 py-4">
        <p class="text-sm text-gray-600">
          가입일: <%= @user.created_at.strftime("%Y년 %m월 %d일") %>
        </p>
        <% if @user.admin? %>
          <p class="text-sm text-amber-600 font-medium mt-1">관리자 계정</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
function initProfileImagePreview() {
  const imageInput = document.getElementById('profile-image-input');
  const imagePreview = document.getElementById('profile-image-preview');
  const defaultAvatar = document.getElementById('default-avatar');
  const fileError = document.getElementById('file-error');

  if (imageInput && !imageInput.dataset.initialized) {
    imageInput.dataset.initialized = 'true';

    imageInput.addEventListener('change', function(e) {
      const file = e.target.files[0];

      if (file) {
        // Check file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
          fileError.classList.remove('hidden');
          imageInput.value = '';
          return;
        } else {
          fileError.classList.add('hidden');
        }

        // Check file type
        if (!file.type.match('image.*')) {
          alert('이미지 파일만 선택할 수 있습니다.');
          imageInput.value = '';
          return;
        }

        // Preview the image
        const reader = new FileReader();
        reader.onload = function(e) {
          imagePreview.src = e.target.result;
          imagePreview.classList.remove('hidden');
          if (defaultAvatar) {
            defaultAvatar.classList.add('hidden');
          }
        };
        reader.readAsDataURL(file);
      }
    });
  }
}

document.addEventListener('DOMContentLoaded', initProfileImagePreview);
document.addEventListener('turbo:load', initProfileImagePreview);
</script>
